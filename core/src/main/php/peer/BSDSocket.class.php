<?php
/* This class is part of the XP framework
 *
 * $Id$
 */

  uses('peer.Socket', 'peer.SocketImpl');
  
  /**
   * BSDSocket implementation
   *
   * @test     xp://net.xp_framework.unittest.peer.sockets.DeprecatedBSDSocketTest
   * @see      php://sockets
   * @see      http://www.developerweb.net/sock-faq/ The UNIX Socket FAQ
   * @ext      sockets
   * @purpose  Provide an interface to the BSD sockets
   * @deprecated Use $impl parameter to peer.Socket instead!
   */
  class BSDSocket extends Socket {
    public
      $domain   = AF_INET,
      $type     = SOCK_STREAM,
      $protocol = SOL_TCP;
    
    static function __static() {
      defined('TCP_NODELAY') || define('TCP_NODELAY', 1);
    }

    /**
     * Constructor
     *
     * Note: When specifying a numerical IPv6 address (e.g. fe80::1)
     * as value for the parameter "host", you must enclose the IP in
     * square brackets.
     *
     * @param   var host hostname or IP address, as string or peer.net.InetAddress
     * @param   int port
     * @param   var handle default NULL
     * @param   lang.XPClass impl default NULL
     */
    public function __construct($host, $port, $handle= NULL, XPClass $impl= NULL) {
      parent::__construct($host, $port, $handle= NULL, SocketImpl::$BSD);
    }

    /**
     * Set Domain
     *
     * @param   int domain one of AF_INET or AF_UNIX
     * @throws  lang.IllegalStateException if socket is already connected
     */
    public function setDomain($domain) {
      if ($this->isConnected()) {
        throw new IllegalStateException('Cannot set domain on connected socket');
      }
      $this->domain= $domain;
    }

    /**
     * Get Domain
     *
     * @return  int
     */
    public function getDomain() {
      return $this->domain;
    }

    /**
     * Set Type
     *
     * @param   int type one of SOCK_STREAM, SOCK_DGRAM, SOCK_RAW, SOCK_SEQPACKET or SOCK_RDM
     * @throws  lang.IllegalStateException if socket is already connected
     */
    public function setType($type) {
      if ($this->isConnected()) {
        throw new IllegalStateException('Cannot set type on connected socket');
      }
      $this->type= $type;
    }

    /**
     * Get Type
     *
     * @return  int
     */
    public function getType() {
      return $this->type;
    }

    /**
     * Set Protocol
     *
     * @see     php://getprotobyname
     * @param   int protocol one of SOL_TCP or SOL_UDP
     * @throws  lang.IllegalStateException if socket is already connected
     */
    public function setProtocol($protocol) {
      if ($this->isConnected()) {
        throw new IllegalStateException('Cannot set protocol on connected socket');
      }
      $this->protocol= $protocol;
    }

    /**
     * Get Protocol
     *
     * @return  int
     */
    public function getProtocol() {
      return $this->protocol;
    }

    /**
     * Get last error
     *
     * @deprecated
     * @return  string error
     */  
    public function getLastError() {
      $e= socket_last_error($this->impl->handle());
      return sprintf('%d: %s', $e, socket_strerror($e));
    }
    
    /**
     * Set socket option
     *
     * @param   int level
     * @param   int name
     * @param   var value
     * @see     php://socket_set_option
     */
    public function setOption($level, $name, $value) {
      $this->impl->option($level, $name, $value);
    }
  }
?>
